import { auth, db } from './firebase-config.js';
import { collection, query, where, orderBy, getDocs, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

let chatsData = [];

export function initPageChatListPage() {
    console.log('ðŸš€ Inizializzazione page-pratiche');
    setupEventListeners();
    loadChats();
}

function setupEventListeners() {
    const newChatBtn = document.getElementById('new-chat-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelModalBtn = document.getElementById('cancel-modal-btn');
    const newChatForm = document.getElementById('new-chat-form');
    const modal = document.getElementById('new-chat-modal');

    newChatBtn.addEventListener('click', () => {
        modal.classList.add('active');
        document.getElementById('client-name').focus();
    });

    closeModalBtn.addEventListener('click', () => {
        modal.classList.remove('active');
        newChatForm.reset();
    });

    cancelModalBtn.addEventListener('click', () => {
        modal.classList.remove('active');
        newChatForm.reset();
    });

    // Chiudi modal cliccando fuori
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
            newChatForm.reset();
        }
    });

    newChatForm.addEventListener('submit', handleCreateChat);
}

async function loadChats() {
    const container = document.getElementById('chats-table-container');

    try {
        const user = auth.currentUser;
        if (!user) {
            throw new Error('Utente non autenticato');
        }

        // Query per ottenere le chat dell'utente corrente
        const chatsRef = collection(db, 'chats');
        const q = query(
            chatsRef,
            where('userId', '==', user.uid),
            orderBy('updatedAt', 'desc')
        );

        const querySnapshot = await getDocs(q);
        chatsData = [];

        querySnapshot.forEach((doc) => {
            chatsData.push({
                id: doc.id,
                ...doc.data()
            });
        });

        renderChatsTable();

    } catch (error) {
        console.error('Errore nel caricamento delle chat:', error);
        container.innerHTML = `
            <div class="empty-state">
                <p style="color: #dc3545;">Errore nel caricamento delle chat: ${error.message}</p>
            </div>
        `;
    }
}

function renderChatsTable() {
    const container = document.getElementById('chats-table-container');

    if (chatsData.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                <h3>Nessuna chat presente</h3>
                <p>Crea la prima chat per iniziare a utilizzare l'AI Legal Assistant</p>
            </div>
        `;
        return;
    }

    const tableHTML = `
        <table class="chats-table">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Pratica</th>
                    <th>Ultimo Aggiornamento</th>
                    <th style="text-align: right;">Azioni</th>
                </tr>
            </thead>
            <tbody>
                ${chatsData.map(chat => `
                    <tr data-chat-id="${chat.id}">
                        <td><strong>${escapeHtml(chat.clientName)}</strong></td>
                        <td>${escapeHtml(chat.caseId)}</td>
                        <td>${formatDate(chat.updatedAt)}</td>
                        <td style="text-align: right;">
                            <div class="chat-actions">
                                <button class="btn btn-primary btn-sm open-chat-btn" data-chat-id="${chat.id}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                                    </svg>
                                    Apri
                                </button>
                                <button class="btn btn-danger btn-sm delete-chat-btn" data-chat-id="${chat.id}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Elimina
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    container.innerHTML = tableHTML;

    // Aggiungi event listeners ai pulsanti
    document.querySelectorAll('.open-chat-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const chatId = btn.dataset.chatId;
            openChat(chatId);
        });
    });

    document.querySelectorAll('.delete-chat-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const chatId = btn.dataset.chatId;
            deleteChat(chatId);
        });
    });

    // Apri chat cliccando sulla riga
    document.querySelectorAll('.chats-table tbody tr').forEach(row => {
        row.addEventListener('click', () => {
            const chatId = row.dataset.chatId;
            openChat(chatId);
        });
    });
}

async function handleCreateChat(e) {
    e.preventDefault();

    const clientName = document.getElementById('client-name').value.trim();
    const caseId = document.getElementById('case-id').value.trim();
    const modal = document.getElementById('new-chat-modal');
    const form = document.getElementById('new-chat-form');

    if (!clientName || !caseId) {
        alert('Compila tutti i campi');
        return;
    }

    try {
        const user = auth.currentUser;
        if (!user) {
            throw new Error('Utente non autenticato');
        }

        // Crea il documento chat
        const chatData = {
            userId: user.uid,
            clientName: clientName,
            caseId: caseId,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        };

        const docRef = await addDoc(collection(db, 'chats'), chatData);
        console.log('âœ… Chat creata con ID:', docRef.id);

        // Chiudi modal e resetta form
        modal.classList.remove('active');
        form.reset();

        // Apri la chat appena creata
        openChat(docRef.id);

    } catch (error) {
        console.error('Errore nella creazione della chat:', error);
        alert('Errore nella creazione della chat: ' + error.message);
    }
}

function openChat(chatId) {
    // Naviga alla pagina della chat con l'ID come parametro
    history.pushState({}, '', `/page-pratica.html?chatId=${chatId}`);

    // Trigger router manualmente
    const routerEvent = new Event('popstate');
    window.dispatchEvent(routerEvent);
}

async function deleteChat(chatId) {
    if (!confirm('Sei sicuro di voler eliminare questa chat? L\'operazione non puÃ² essere annullata.')) {
        return;
    }

    try {
        await deleteDoc(doc(db, 'chats', chatId));
        console.log('âœ… Chat eliminata:', chatId);

        // Ricarica la lista
        await loadChats();

    } catch (error) {
        console.error('Errore nell\'eliminazione della chat:', error);
        alert('Errore nell\'eliminazione della chat: ' + error.message);
    }
}

function formatDate(timestamp) {
    if (!timestamp) return 'N/D';

    // Gestisci sia Timestamp di Firestore che Date normali
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);

    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (days === 0) {
        return 'Oggi ' + date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    } else if (days === 1) {
        return 'Ieri ' + date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    } else if (days < 7) {
        return days + ' giorni fa';
    } else {
        return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
